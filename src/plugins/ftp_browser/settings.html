<div class="form-group">
    <label for="server" class="form-label">FTP Server:</label>
    <input type="text" id="server" name="server" placeholder="ftp.example.com" required class="form-input">
</div>

<div class="form-group">
    <label for="port" class="form-label">Port:</label>
    <input type="number" id="port" name="port" placeholder="21" value="21" class="form-input">
    <small class="form-text text-muted">Default FTP port is 21</small>
</div>

<div class="form-group">
    <label for="username" class="form-label">Username:</label>
    <input type="text" id="username" name="username" placeholder="anonymous" class="form-input">
</div>

<div class="form-group">
    <label for="password" class="form-label">Password:</label>
    <input type="password" id="password" name="password" placeholder="Password" class="form-input">
</div>

<div class="form-group">
    <label for="initial_path" class="form-label">Share Path:</label>
    <input type="text" id="initial_path" name="initial_path" placeholder="/volume1/photos" class="form-input">
    <small class="form-text text-muted">Specify your Synology share (e.g., /volume1/photos)</small>
</div>

<div class="form-group">
    <label for="use_tls" class="form-label">Use FTPS (TLS):</label>
    <div class="toggle-container">
        <input type="checkbox" id="use_tls" name="use_tls" class="toggle-checkbox" value="false"
            onclick="this.value = this.checked ? 'true' : 'false'">
        <label for="use_tls" class="toggle-label"></label>
    </div>
</div>

<div class="form-group">
    <label for="passive" class="form-label">Use Passive Mode:</label>
    <div class="toggle-container">
        <input type="checkbox" id="passive" name="passive" class="toggle-checkbox" value="true" checked
            onclick="this.value = this.checked ? 'true' : 'false'">
        <label for="passive" class="toggle-label"></label>
    </div>
</div>

<div class="form-group">
    <label for="padImage" class="form-label">Fit Image to Frame:</label>
    <div class="toggle-container">
        <input type="checkbox" id="padImage" name="padImage" class="toggle-checkbox" value="false"
            onclick="this.value = this.checked ? 'true' : 'false'">
        <label for="padImage" class="toggle-label"></label>
    </div>
</div>

<div class="form-group">
    <label for="verticalHandling" class="form-label">Vertical Image Handling:</label>
    <select id="verticalHandling" name="verticalHandling" class="form-input">
        <option value="rotate">Rotate to fit</option>
        <option value="crop">Crop and center</option>
    </select>
    <small class="form-text text-muted">How to display vertical images on horizontal frame</small>
</div>

<div class="form-group">
    <label for="random_mode" class="form-label">Random Image Mode:</label>
    <div class="toggle-container">
        <input type="checkbox" id="random_mode" name="random_mode" class="toggle-checkbox" value="false"
            onclick="this.value = this.checked ? 'true' : 'false'; updateBrowserVisibility();">
        <label for="random_mode" class="toggle-label"></label>
    </div>
</div>

<!-- Hidden field to store the current path -->
<input type="hidden" id="current_path" name="current_path" value="/">
<!-- Hidden field to store the selected image path -->
<input type="hidden" id="selected_image" name="selected_image" value="">

<!-- FTP Browser section -->
<div id="ftp_browser_section" class="form-group">
    <div class="browser-header">
        <button type="button" id="connect_btn" class="btn btn-primary" onclick="connectToFTP()">Connect</button>
        <button type="button" id="clear_cache_btn" class="btn btn-secondary" onclick="clearFTPCache()" title="Clear saved connection settings">Clear Saved</button>
        <span id="current_path_display">/</span>
    </div>
    
    <div id="browser_loading" class="browser-loading" style="display: none;">
        <div class="spinner"></div>
        <p>Loading...</p>
    </div>
    
    <div id="browser_error" class="browser-error" style="display: none;">
        <p id="error_message">Error connecting to FTP server.</p>
    </div>
    
    <div id="browser_content" class="browser-content" style="display: none;">
        <div class="browser-nav">
            <button type="button" class="browser-btn" onclick="navigateUp()">‚¨ÜÔ∏è Up</button>
            <button type="button" class="browser-btn" onclick="refreshDirectory()">üîÑ Refresh</button>
        </div>
        
        <div id="directory_listing" class="directory-listing">
            <!-- Directory and file entries will be populated here -->
        </div>
    </div>
    
    <div id="image_preview" class="image-preview" style="display: none;">
        <img id="preview_image" src="" alt="Preview">
        <div class="preview-controls">
            <button type="button" class="browser-btn" onclick="clearSelection()">Cancel</button>
            <button type="button" class="browser-btn browser-btn-primary" onclick="confirmSelection()">Select</button>
        </div>
    </div>
</div>

<style>
    .browser-header {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
    }
    
    #current_path_display {
        margin-left: 10px;
        font-family: monospace;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        flex: 1;
    }
    
    .btn-secondary {
        background-color: #6c757d;
        color: white;
        border: 1px solid #6c757d;
        margin-left: 5px;
        padding: 6px 12px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9em;
    }
    
    .btn-secondary:hover {
        background-color: #5a6268;
        border-color: #545b62;
    }
    
    .browser-loading {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 200px;
    }
    
    .spinner {
        border: 4px solid rgba(0, 0, 0, 0.1);
        border-radius: 50%;
        border-top: 4px solid #3498db;
        width: 30px;
        height: 30px;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .browser-error {
        background-color: #ffebee;
        color: #c62828;
        padding: 10px;
        border-radius: 4px;
        margin-top: 10px;
    }
    
    .browser-content {
        margin-top: 10px;
    }
    
    .browser-nav {
        display: flex;
        margin-bottom: 10px;
    }
    
    .browser-btn {
        padding: 6px 12px;
        border: 1px solid #ccc;
        background-color: #f8f9fa;
        border-radius: 4px;
        cursor: pointer;
        margin-right: 5px;
    }
    
    .browser-btn:hover {
        background-color: #e9ecef;
    }
    
    .browser-btn-primary {
        background-color: #007bff;
        color: white;
        border-color: #007bff;
    }
    
    .browser-btn-primary:hover {
        background-color: #0069d9;
    }
    
    .directory-listing {
        border: 1px solid #ddd;
        border-radius: 4px;
        max-height: 300px;
        overflow-y: auto;
    }
    
    .dir-entry {
        padding: 8px 12px;
        border-bottom: 1px solid #eee;
        display: flex;
        align-items: center;
        cursor: pointer;
    }
    
    .dir-entry:last-child {
        border-bottom: none;
    }
    
    .dir-entry:hover {
        background-color: #f5f5f5;
    }
    
    .dir-entry-icon {
        margin-right: 10px;
        font-size: 1.2em;
    }
    
    .dir-entry-name {
        flex: 1;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    
    .image-preview {
        margin-top: 15px;
        text-align: center;
    }
    
    #preview_image {
        max-width: 100%;
        max-height: 200px;
        border: 1px solid #ddd;
        border-radius: 4px;
        margin-bottom: 10px;
    }
    
    .preview-controls {
        display: flex;
        justify-content: center;
        gap: 10px;
    }
</style>

<script>
    // Track the current state
    let currentPath = '/';
    let selectedImage = '';
    let ftpContents = null;
    
    // Function to save FTP connection settings to localStorage
    function saveFTPSettings() {
        const settings = {
            server: document.getElementById('server').value,
            port: document.getElementById('port').value,
            username: document.getElementById('username').value,
            password: document.getElementById('password').value, // Consider if you want to store this
            initial_path: document.getElementById('initial_path').value,
            use_tls: document.getElementById('use_tls').checked,
            passive: document.getElementById('passive').checked,
            last_updated: new Date().toISOString()
        };
        
        // Save to localStorage
        localStorage.setItem('ftpBrowserSettings', JSON.stringify(settings));
    }
    
    // Function to load FTP connection settings from localStorage
    function loadFTPSettings() {
        const savedSettings = localStorage.getItem('ftpBrowserSettings');
        if (savedSettings) {
            const settings = JSON.parse(savedSettings);
            
            // Only use saved settings if they don't already have values from pluginSettings
            if (!document.getElementById('server').value) {
                document.getElementById('server').value = settings.server || '';
            }
            if (document.getElementById('port').value === '21') {
                document.getElementById('port').value = settings.port || '21';
            }
            if (!document.getElementById('username').value || document.getElementById('username').value === 'anonymous') {
                document.getElementById('username').value = settings.username || 'anonymous';
            }
            if (!document.getElementById('password').value) {
                document.getElementById('password').value = settings.password || '';
            }
            if (!document.getElementById('initial_path').value || document.getElementById('initial_path').value === '/') {
                document.getElementById('initial_path').value = settings.initial_path || '/';
            }
            document.getElementById('use_tls').checked = settings.use_tls || false;
            document.getElementById('passive').checked = settings.passive !== false; // Default to true
            
            // Update checkbox values
            document.getElementById('use_tls').value = document.getElementById('use_tls').checked ? 'true' : 'false';
            document.getElementById('passive').value = document.getElementById('passive').checked ? 'true' : 'false';
            
            return true;
        }
        return false;
    }
    
    // Function to update browser visibility based on random mode
    function updateBrowserVisibility() {
        const randomMode = document.getElementById('random_mode').checked;
        const browserSection = document.getElementById('ftp_browser_section');
        
        if (randomMode) {
            // If random mode, we just need to select a directory
            document.getElementById('current_path_display').textContent = currentPath;
            browserSection.style.display = 'block';
        } else {
            // If not random mode, we need to select a specific image
            browserSection.style.display = 'block';
        }
    }
    
    // Function to connect to the FTP server and list the root directory
    function connectToFTP() {
        const server = document.getElementById('server').value;
        const port = document.getElementById('port').value || '21';
        const username = document.getElementById('username').value || 'anonymous';
        const password = document.getElementById('password').value || '';
        const useTLS = document.getElementById('use_tls').checked;
        const passive = document.getElementById('passive').checked;
        const initialPath = document.getElementById('initial_path').value || '/';
        
        if (!server) {
            showError('Server address is required');
            return;
        }
        
        // Save settings to localStorage whenever connecting
        saveFTPSettings();
        
        // Show loading state
        document.getElementById('browser_loading').style.display = 'flex';
        document.getElementById('browser_content').style.display = 'none';
        document.getElementById('browser_error').style.display = 'none';
        document.getElementById('image_preview').style.display = 'none';
        
        // Make AJAX call to backend to list directory
        fetch('/api/plugins/ftp_browser/list_directory', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                server: server,
                port: parseInt(port),
                username: username,
                password: password,
                use_tls: useTLS,
                passive: passive,
                path: initialPath
            })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            if (data.error) {
                throw new Error(data.error);
            }
            
            // Update with real data from server
            ftpContents = data;
            
            // Update current path
            currentPath = ftpContents.current_path;
            document.getElementById('current_path').value = currentPath;
            document.getElementById('current_path_display').textContent = currentPath;
            
            // Populate directory listing
            populateDirectoryListing(ftpContents);
            
            // Show browser content
            document.getElementById('browser_loading').style.display = 'none';
            document.getElementById('browser_content').style.display = 'block';
        })
        .catch(error => {
            document.getElementById('browser_loading').style.display = 'none';
            showError('Failed to connect to FTP server: ' + error.message);
        });
    }
    
    // Function to clear saved FTP settings
    function clearFTPCache() {
        // Remove from localStorage
        localStorage.removeItem('ftpBrowserSettings');
        
        // Optional: Clear the form values if not from a saved plugin instance
        if (!(typeof loadPluginSettings !== 'undefined' && loadPluginSettings)) {
            document.getElementById('server').value = '';
            document.getElementById('port').value = '21';
            document.getElementById('username').value = 'anonymous';
            document.getElementById('password').value = '';
            document.getElementById('initial_path').value = '/';
            document.getElementById('use_tls').checked = false;
            document.getElementById('use_tls').value = 'false';
            document.getElementById('passive').checked = true;
            document.getElementById('passive').value = 'true';
        }
        
        // Show confirmation
        alert('Saved FTP connection settings have been cleared.');
    }
    
    // Function to show an error message
    function showError(message) {
        document.getElementById('error_message').textContent = message;
        document.getElementById('browser_error').style.display = 'block';
    }
    
    // Function to populate the directory listing
    function populateDirectoryListing(contents) {
        const listingElement = document.getElementById('directory_listing');
        listingElement.innerHTML = '';
        
        // Add parent directory entry if not at root
        if (contents.current_path !== '/') {
            const parentEntry = document.createElement('div');
            parentEntry.className = 'dir-entry';
            parentEntry.innerHTML = `
                <span class="dir-entry-icon">üìÅ</span>
                <span class="dir-entry-name">..</span>
            `;
            parentEntry.addEventListener('click', () => navigateTo(contents.parent_path));
            listingElement.appendChild(parentEntry);
        }
        
        // Add directories
        contents.directories.forEach(dir => {
            const dirEntry = document.createElement('div');
            dirEntry.className = 'dir-entry';
            dirEntry.innerHTML = `
                <span class="dir-entry-icon">üìÅ</span>
                <span class="dir-entry-name">${dir.name}</span>
            `;
            dirEntry.addEventListener('click', () => navigateTo(dir.path));
            listingElement.appendChild(dirEntry);
        });
        
        // Add files (only images)
        contents.files.forEach(file => {
            const fileEntry = document.createElement('div');
            fileEntry.className = 'dir-entry';
            fileEntry.innerHTML = `
                <span class="dir-entry-icon">üñºÔ∏è</span>
                <span class="dir-entry-name">${file.name}</span>
            `;
            fileEntry.addEventListener('click', () => previewImage(file.path));
            listingElement.appendChild(fileEntry);
        });
        
        // If no entries, show a message
        if (contents.directories.length === 0 && contents.files.length === 0) {
            const emptyMessage = document.createElement('div');
            emptyMessage.className = 'dir-entry';
            emptyMessage.innerHTML = `
                <span class="dir-entry-name">Empty directory</span>
            `;
            listingElement.appendChild(emptyMessage);
        }
    }
    
    // Function to navigate to a directory
    function navigateTo(path) {
        // Show loading state
        document.getElementById('browser_loading').style.display = 'flex';
        document.getElementById('browser_content').style.display = 'none';
        document.getElementById('browser_error').style.display = 'none';
        document.getElementById('image_preview').style.display = 'none';
        
        // Get server connection details
        const server = document.getElementById('server').value;
        const port = document.getElementById('port').value || '21';
        const username = document.getElementById('username').value || 'anonymous';
        const password = document.getElementById('password').value || '';
        const useTLS = document.getElementById('use_tls').checked;
        const passive = document.getElementById('passive').checked;
        
        // Make AJAX call to backend to list directory
        fetch('/api/plugins/ftp_browser/list_directory', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                server: server,
                port: parseInt(port),
                username: username,
                password: password,
                use_tls: useTLS,
                passive: passive,
                path: path
            })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            if (data.error) {
                throw new Error(data.error);
            }
            
            // Update with real data from server
            ftpContents = data;
            
            // Update current path
            currentPath = ftpContents.current_path;
            document.getElementById('current_path').value = currentPath;
            document.getElementById('current_path_display').textContent = currentPath;
            
            // Populate directory listing
            populateDirectoryListing(ftpContents);
            
            // Show browser content
            document.getElementById('browser_loading').style.display = 'none';
            document.getElementById('browser_content').style.display = 'block';
            
            // If in random mode and navigated to a directory, update the selected path
            if (document.getElementById('random_mode').checked) {
                document.getElementById('selected_image').value = '';
            }
        })
        .catch(error => {
            document.getElementById('browser_loading').style.display = 'none';
            showError('Failed to navigate to directory: ' + error.message);
        });
    }
    
    // Function to navigate up one directory
    function navigateUp() {
        if (currentPath !== '/') {
            navigateTo(ftpContents.parent_path);
        }
    }
    
    // Function to refresh the current directory
    function refreshDirectory() {
        navigateTo(currentPath);
    }
    
    // Function to preview an image
    function previewImage(path) {
        // Hide browser content and show image preview
        document.getElementById('browser_content').style.display = 'none';
        document.getElementById('image_preview').style.display = 'block';
        
        // Get server connection details
        const server = document.getElementById('server').value;
        const port = document.getElementById('port').value || '21';
        const username = document.getElementById('username').value || 'anonymous';
        const password = document.getElementById('password').value || '';
        const useTLS = document.getElementById('use_tls').checked;
        const passive = document.getElementById('passive').checked;
        
        // Make AJAX call to backend to get preview image
        fetch('/api/plugins/ftp_browser/preview_image', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                server: server,
                port: parseInt(port),
                username: username,
                password: password,
                use_tls: useTLS,
                passive: passive,
                path: path
            })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            if (data.error) {
                throw new Error(data.error);
            }
            
            // Update the preview image with the returned base64 data
            document.getElementById('preview_image').src = 'data:image/jpeg;base64,' + data.preview;
            
            // Update selected image
            selectedImage = path;
        })
        .catch(error => {
            showError('Failed to preview image: ' + error.message);
            // Go back to browser view
            document.getElementById('image_preview').style.display = 'none';
            document.getElementById('browser_content').style.display = 'block';
        });
    }
    
    // Function to clear the image selection
    function clearSelection() {
        // Hide image preview and show browser content
        document.getElementById('image_preview').style.display = 'none';
        document.getElementById('browser_content').style.display = 'block';
        
        // Clear selected image
        selectedImage = '';
    }
    
    // Function to confirm the image selection
    function confirmSelection() {
        // Update the selected image field
        document.getElementById('selected_image').value = selectedImage;
        
        // Hide image preview and show browser content
        document.getElementById('image_preview').style.display = 'none';
        document.getElementById('browser_content').style.display = 'block';
        
        // Show confirmation message
        alert('Image selected: ' + selectedImage);
    }
    
    // Initialize the form on load
    document.addEventListener('DOMContentLoaded', () => {
        let settingsLoaded = false;
        
        // Populate form values from plugin settings if available
        if (typeof loadPluginSettings !== 'undefined' && loadPluginSettings) {
            document.getElementById('server').value = pluginSettings.server || '';
            document.getElementById('port').value = pluginSettings.port || '21';
            document.getElementById('username').value = pluginSettings.username || 'anonymous';
            document.getElementById('password').value = pluginSettings.password || '';
            document.getElementById('initial_path').value = pluginSettings.initial_path || '/';
            document.getElementById('use_tls').checked = pluginSettings.use_tls === 'true';
            document.getElementById('passive').checked = pluginSettings.passive !== 'false';
            document.getElementById('padImage').checked = pluginSettings.padImage === 'true';
            document.getElementById('verticalHandling').value = pluginSettings.verticalHandling || 'rotate';
            document.getElementById('random_mode').checked = pluginSettings.random_mode === 'true';
            document.getElementById('current_path').value = pluginSettings.current_path || '/';
            document.getElementById('selected_image').value = pluginSettings.selected_image || '';
            
            // Update browser visibility based on random mode
            updateBrowserVisibility();
            
            // If we have server credentials, try to connect automatically
            if (pluginSettings.server) {
                connectToFTP();
                settingsLoaded = true;
            }
        } 
        
        // If no plugin settings were loaded, try loading from localStorage
        if (!settingsLoaded) {
            const hasCache = loadFTPSettings();
            
            // Set default values for fields that might not be in saved settings
            if (!document.getElementById('port').value) {
                document.getElementById('port').value = '21';
            }
            if (!document.getElementById('username').value) {
                document.getElementById('username').value = 'anonymous';
            }
            if (!document.getElementById('passive').checked) {
                document.getElementById('passive').checked = true;
            }
            if (!document.getElementById('current_path').value) {
                document.getElementById('current_path').value = '/';
            }
            if (!document.getElementById('initial_path').value) {
                document.getElementById('initial_path').value = '/';
            }
            
            // If we successfully loaded cached settings and have a server, try to connect
            if (hasCache && document.getElementById('server').value) {
                connectToFTP();
            }
        }
        
        // Add event listeners to all form inputs to save settings when they change
        const formInputs = document.querySelectorAll('input[type=text], input[type=number], input[type=password]');
        formInputs.forEach(input => {
            input.addEventListener('change', saveFTPSettings);
        });
        
        const checkboxes = document.querySelectorAll('input[type=checkbox]');
        checkboxes.forEach(checkbox => {
            checkbox.addEventListener('change', saveFTPSettings);
        });
    });
</script>